<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>お気に入り</title>
    <link rel="stylesheet" href="/css/wakamusic.css">
</head>
<body>
    <h1>お気に入りの曲</h1>
    
  <button id="save-btn">セーブ</button>
  <button id="load-btn">ロード</button>


    <% if (tracks.length > 0) { %>
 <ul class="track-list">
  <% tracks.forEach(track => { %>
    <li class="track-item">
      <img src="<%= track.artwork_url %>" alt="Artwork" class="track-artwork">
      <div class="track-info">
        <h3><%= track.title %></h3>
        <button class="play-btn" data-track-id="<%= track.id %>">Play</button>
      </div>
    </li>
  <% }); %>
</ul>
    <% } else { %>
        <p>お気に入りに登録された曲はありません。</p>
    <% } %>

<div class="player-bar" id="player-bar">
    <iframe id="sc-player" scrolling="no" frameborder="no"></iframe>
</div>

<script>
    document.querySelectorAll('.play-btn').forEach(element => {
        element.addEventListener('click', function(e) {
            e.preventDefault();
            const trackId = e.target.getAttribute('data-track-id');
            playTrack(trackId);
        });
    });

    function playTrack(trackId) {
        const playerBar = document.getElementById('player-bar');
        const player = document.getElementById('sc-player');

        player.src = `https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/tracks/${trackId}&color=%23ff5500&auto_play=true`;

        playerBar.style.display = 'flex';
    }
  
function toggleFavorite(artwork_url, title, id) {
    let favorites = getFavoritesFromCookies();

    const favoriteIndex = favorites.findIndex(track => track.id === id);

    if (favoriteIndex === -1) {
        favorites.push({ artwork_url, title, id });
        alert('お気に入りに追加しました！');
    } else {
        favorites.splice(favoriteIndex, 1);
        alert('お気に入りを解除しました！');
    }

    document.cookie = `wakamemusicfavorites=${encodeURIComponent(JSON.stringify(favorites))}; path=/; max-age=31536000`;

    updateFavoriteButton(id);
}

function getFavoritesFromCookies() {
    const favoritesCookie = document.cookie.split('; ').find(row => row.startsWith('wakamemusicfavorites='));
    if (favoritesCookie) {
        const cookieValue = favoritesCookie.split('=')[1];
        try {
            return JSON.parse(decodeURIComponent(cookieValue));
        } catch (error) {
            console.error('Error parsing favorites cookie:', error);
            return [];
        }
    }
    return [];
}
  
document.addEventListener("DOMContentLoaded", function() {
    console.log("DOMContentLoaded: イベントリスナーが追加されました");

    document.getElementById('save-btn').addEventListener('click', function() {
        showFavorites();
    });

    document.getElementById('load-btn').addEventListener('click', function() {
        loadFavorites();
    });
});

function showFavorites() {
    let savefavorites = getFavoritesFromCookies();
    if (savefavorites.length > 0) {
        alert(`お気に入り: \n${JSON.stringify(savefavorites, null, 2)}`);
    } else {
        alert("お気に入りは空です。");
    }
}

function loadFavorites() {
    let input = prompt("セーブデータを入力して下さい:");
    try {
        const parsedFavorites = JSON.parse(input);

        if (Array.isArray(parsedFavorites) && parsedFavorites.every(item => item.artwork_url && item.title && item.id)) {
            document.cookie = `wakamemusicfavorites=${JSON.stringify(parsedFavorites)}; path=/`;
            alert("cookieに保存されました。");
        } else {
            alert("無効なフォーマットです。正しいデータを入力してください。");
        }
    } catch (e) {
        alert("JSONのパースに失敗しました。正しい形式で入力してください。");
    }
}

function getFavoritesFromCookies() {
    const cookieName = 'wakamemusicfavorites';
    const cookieValue = document.cookie.split('; ').find(row => row.startsWith(cookieName));
    const favorites = cookieValue ? JSON.parse(cookieValue.split('=')[1]) : [];
    console.log("取得したお気に入り: ", favorites);
    return favorites;
}
</script>
</body>
</html>
